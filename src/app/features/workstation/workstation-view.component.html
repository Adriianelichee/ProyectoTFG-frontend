<div class="workstation-view-container" *ngIf="!loading && workstation">
  <div class="workstation-view-card">
    <div class="workstation-header">
      <div class="workstation-title">
        <h2>Estación de Trabajo</h2>
        <span class="workstation-id">#{{ workstation.workstationId }}</span>
      </div>
      <div class="workstation-status" [class.available]="workstation.available">
        {{ workstation.available ? 'Disponible' : 'No disponible' }}
      </div>
    </div>

    <div class="workstation-details">
      <div class="detail-section">
        <h3>Información General</h3>
        <div class="detail-grid">
          <div class="detail-item">
            <div class="detail-icon">
              <i class="fas fa-id-card"></i>
            </div>
            <div class="detail-content">
              <span class="detail-label">ID de la estación</span>
              <span class="detail-value">{{ workstation.workstationId }}</span>
            </div>
          </div>

          <div class="detail-item">
            <div class="detail-icon">
              <i class="fas fa-euro-sign"></i>
            </div>
            <div class="detail-content">
              <span class="detail-label">Tarifa por hora</span>
              <span class="detail-value">{{ workstation.hourlyRate }}€</span>
            </div>
          </div>

          <div class="detail-item">
            <div class="detail-icon">
              <i class="fas fa-building"></i>
            </div>
            <div class="detail-content">
              <span class="detail-label">Planta</span>
              <span class="detail-value">{{ floorName || 'Planta ' + workstation.floorId }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Sección de disponibilidad y calendario -->
      <div class="availability-section" *ngIf="workstation.available">
        <h3>Disponibilidad</h3>

        <!-- Mensaje de éxito cuando la reserva se completa -->
        <div class="success-message" *ngIf="successMessage">
          <i class="fas fa-check-circle"></i>
          <span>{{ successMessage }}</span>
        </div>

        <!-- Controles del calendario -->
        <div class="calendar-controls">
          <div class="calendar-navigation">
            <button *ngIf="calendarView === 'week'" (click)="navigateWeek(-1)" class="btn-calendar-nav">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button *ngIf="calendarView === 'month'" (click)="navigateMonth(-1)" class="btn-calendar-nav">
              <i class="fas fa-chevron-left"></i>
            </button>

            <span class="calendar-title">
                        {{ selectedDate | date:'MMMM yyyy' }}
                      </span>

            <button *ngIf="calendarView === 'week'" (click)="navigateWeek(1)" class="btn-calendar-nav">
              <i class="fas fa-chevron-right"></i>
            </button>
            <button *ngIf="calendarView === 'month'" (click)="navigateMonth(1)" class="btn-calendar-nav">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>

          <div class="calendar-view-toggle">
            <button
              class="btn-view-toggle"
              [class.active]="calendarView === 'week'"
              (click)="calendarView = 'week'">
              Semana
            </button>
            <button
              class="btn-view-toggle"
              [class.active]="calendarView === 'month'"
              (click)="calendarView = 'month'">
              Mes
            </button>
          </div>
        </div>

        <!-- Vista semanal del calendario -->
        <div *ngIf="calendarView === 'week'" class="week-calendar">
          <div class="week-days">
            <div
              *ngFor="let day of weekSchedule"
              class="day-column"
              [class.today]="isSameDay(day.dateObj, selectedDate)"
              [class.selected]="day.date === bookingForm.get('bookingDate')?.value">
              <div class="day-header" (click)="selectDate(day)">
                <div class="day-name">{{ day.dayName }}</div>
                <div class="day-number">{{ day.dateObj | date:'d' }}</div>
              </div>

              <div class="time-slots">
                <div
                  *ngFor="let slot of day.slots"
                  class="time-slot"
                  [class.available]="slot.available"
                  [class.unavailable]="!slot.available"
                  [class.selected]="day.date === bookingForm.get('bookingDate')?.value &&
                                               slot.time === bookingForm.get('startTime')?.value"
                  (click)="selectTimeSlot(day, slot)">
                  {{ slot.time }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Vista mensual del calendario -->
        <div *ngIf="calendarView === 'month'" class="month-calendar">
          <div class="month-header">
            <div *ngFor="let day of ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom']" class="weekday-header">
              {{ day }}
            </div>
          </div>

          <div class="month-grid">
            <div
              *ngFor="let day of currentMonthDays"
              class="day-cell"
              [class.other-month]="!day.isCurrentMonth"
              [class.today]="day.isToday"
              [class.has-events]="day.hasEvents"
              [class.selected]="day.isCurrentMonth && isSelectedDay(day)"
              (click)="day.isCurrentMonth && selectMonthDay(day)">
              {{ day.date }}
              <div class="event-indicator" *ngIf="day.hasEvents"></div>
            </div>
          </div>
        </div>

        <!-- Formulario de reserva -->
        <form *ngIf="showBookingForm" class="booking-form-container" [formGroup]="bookingForm"
              (ngSubmit)="onBookSubmit()">
          <div class="form-row">
            <div class="form-group">
              <label for="bookingDate">Fecha de reserva</label>
              <div class="input-container">
                <i class="fas fa-calendar-day input-icon"></i>
                <input id="bookingDate" type="date" formControlName="bookingDate" (change)="onDateChange($event)"/>
              </div>
              <small class="error-text"
                     *ngIf="bookingForm.get('bookingDate')?.invalid && bookingForm.get('bookingDate')?.touched">
                La fecha es obligatoria
              </small>
            </div>

            <div class="form-group">
              <label for="startTime">Hora de inicio</label>
              <div class="input-container">
                <i class="fas fa-clock input-icon"></i>
                <select id="startTime" formControlName="startTime">
                  <option value="">Seleccionar hora</option>
                  <option *ngFor="let time of availableTimes" [value]="time">{{ time }}</option>
                </select>
              </div>
              <small class="error-text"
                     *ngIf="bookingForm.get('startTime')?.invalid && bookingForm.get('startTime')?.touched">
                La hora es obligatoria
              </small>
              <small *ngIf="availableTimes.length === 0" class="warning-text">
                No hay horarios disponibles para esta fecha
              </small>
            </div>

            <div class="form-group">
              <label for="duration">Duración (horas)</label>
              <div class="input-container">
                <i class="fas fa-hourglass-half input-icon"></i>
                <select id="duration" formControlName="duration">
                  <option value="1">1 hora</option>
                  <option value="2">2 horas</option>
                  <option value="3">3 horas</option>
                  <option value="4">4 horas</option>
                  <option value="8">8 horas (día completo)</option>
                </select>
              </div>
              <small class="info-text">Al cambiar la duración se actualizará la disponibilidad</small>
            </div>
          </div>

          <div class="booking-summary" *ngIf="bookingForm.valid">
            <div class="summary-detail">
              <span class="summary-label">Hora inicio:</span>
              <span class="summary-value">{{ bookingForm.get('startTime')?.value }}</span>
            </div>
            <div class="summary-detail" *ngIf="bookingForm.get('startTime')?.value">
              <span class="summary-label">Hora fin:</span>
              <span
                class="summary-value">{{ calculateEndTime(bookingForm.get('startTime')?.value, bookingForm.get('duration')?.value) }}</span>
            </div>
            <div class="summary-detail">
              <span class="summary-label">Coste total:</span>
              <span class="summary-value">{{ calculatePrice() | currency:'EUR':'symbol':'1.2-2' }}</span>
            </div>
          </div>

          <div class="booking-actions">
            <button type="button" class="btn-cancel" (click)="toggleBookingForm()">
              <i class="fas fa-times"></i> Cancelar
            </button>
            <button type="submit" class="btn-reserve" [disabled]="!bookingForm.valid || reservationLoading">
              <i class="fas fa-spinner fa-spin" *ngIf="reservationLoading"></i>
              <i class="fas fa-check" *ngIf="!reservationLoading"></i>
              {{ reservationLoading ? 'Procesando...' : 'Confirmar reserva' }}
            </button>
          </div>

          <!-- Mensaje de error en el formulario -->
          <div class="error-message-form" *ngIf="errorMessage">
            <i class="fas fa-exclamation-circle"></i>
            <span>{{ errorMessage }}</span>
          </div>
        </form>

        <!-- Botón para mostrar el formulario -->
        <div class="booking-form" *ngIf="!showBookingForm">
          <button class="btn-show-booking" (click)="toggleBookingForm()">
            <i class="fas fa-clock"></i> Reservar horario seleccionado
          </button>
        </div>
      </div>

      <!-- Mensaje si no está disponible -->
      <div class="not-available-message" *ngIf="!workstation.available">
        <i class="fas fa-ban"></i>
        <p>Esta estación de trabajo no está disponible para reservas actualmente</p>
      </div>
    </div>

    <div class="workstation-actions">
      <button class="btn-back" (click)="onBack()">
        <i class="fas fa-arrow-left"></i> Volver a la lista
      </button>
      <button class="btn-reserve-main" *ngIf="workstation.available && !showBookingForm" (click)="toggleBookingForm()">
        <i class="fas fa-calendar-plus"></i> Reservar estación
      </button>
      <button class="btn-edit" *ngIf="isAdmin" (click)="onEdit()">
        <i class="fas fa-edit"></i> Editar estación
      </button>
    </div>
  </div>
</div>

<div *ngIf="loading" class="loading-container">
  <div class="loading-spinner"></div>
  <span>Cargando información de la estación de trabajo...</span>
</div>

<div *ngIf="errorMessage && !workstation" class="error-container">
  <i class="fas fa-exclamation-circle"></i>
  <span>{{ errorMessage }}</span>
  <button class="btn-retry" (click)="loadWorkstation()">Reintentar</button>
</div>
